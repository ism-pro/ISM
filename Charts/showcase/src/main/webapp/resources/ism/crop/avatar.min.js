
PrimeFaces.widget.CropAvatar=PrimeFaces.widget.BaseWidget.extend({init:function(b){this._super(b);this.$container=$(this.jqId);this.$avatarView=this.$container.find(".avatar-view");this.$avatar=this.$avatarView.find("img");this.$avatarModal=this.$container.find("#avatar-modal");this.$loading=this.$container.find(".loading");this.$avatarForm=this.$avatarModal.find("#avatar-form");this.$avatarUpload=this.$avatarForm.find(".avatar-upload");this.$avatarSrc=this.$avatarForm.find(".avatar-src");this.$avatarData=this.$avatarForm.find(".avatar-data");this.$avatarInput=this.$avatarForm.find(".avatar-input");this.$avatarSave=this.$avatarForm.find(".avatar-save");this.$avatarBtns=this.$avatarForm.find(".avatar-btns");this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper");this.$avatarPreview=this.$avatarModal.find(".avatar-preview");this.build(this)},support:{fileList:!!$('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},build:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs;if(!this.support.formData){this.initIframe()}this.initTooltip();this.initModal();this.bindEvents()},initTooltip:function(){this.$avatarView.tooltip({placement:"bottom"})},initModal:function(){this.$avatarModal.modal({show:false})},initPreview:function(){var a=this.$avatar.attr("src");this.$avatarPreview.html('<img src="'+a+'">')},initIframe:function(){console.log("Init Frame");var b="upload-iframe-"+(new Date()).getTime();var a=$("<iframe>").attr({name:b,src:""});var c=this;a.one("load",function(){a.on("load",function(){var d;try{d=$(this).contents().find("body").text()}catch(f){console.log(f.message)}if(d){try{d=$.parseJSON(d)}catch(f){console.log(f.message)}c.submitDone(d)}else{c.submitFail("Image upload failed!")}c.submitEnd()})});this.$iframe=a;this.$avatarForm.attr("target",b).after(a.hide())},bindEvents:function(){var a=this;this.$avatarView.on("click",$.proxy(this.click,this));this.$avatarInput.on("change",$.proxy(this.change,this));this.$avatarForm.on("submit",$.proxy(this.submit,this));this.$avatarBtns.on("click",$.proxy(this.rotate,this));this.$avatarSave.click(function(b){a.submit()})},click:function(){this.$avatarModal.modal("show");this.initPreview()},change:function(){var b,a;if(this.support.datauri){b=this.$avatarInput.prop("files");if(b.length>0){a=b[0];if(this.isImageFile(a)){if(this.url){URL.revokeObjectURL(this.url)}this.url=URL.createObjectURL(a);this.startCropper()}}}else{a=this.$avatarInput.val();if(this.isImageFile(a)){this.syncUpload()}}},submit:function(){console.log("submit");if(!this.$avatarSrc.val()&&!this.$avatarInput.val()){return false}if(this.support.formData){this.ajaxUpload();return false}},rotate:function(b){var a;if(this.active){a=$(b.target).data();if(a.method){this.$img.cropper(a.method,a.option)}}},isImageFile:function(a){console.log("isImageFile");if(a.type){return/^image\/\w+$/.test(a.type)}else{return/\.(jpg|jpeg|png|gif)$/.test(a)}},startCropper:function(){console.log("start Cropper");var a=this;if(this.active){console.log("start cropper : url : "+this.url);this.$img.cropper("replace",this.url)}else{this.$img=$('<img src="'+this.url+'">');this.$avatarWrapper.empty().html(this.$img);this.$img.cropper({aspectRatio:1,preview:this.$avatarPreview.selector,crop:function(c){var b=['{"x":'+c.x,'"y":'+c.y,'"height":'+c.height,'"width":'+c.width,'"rotate":'+c.rotate+"}"].join();a.$avatarData.val(b)}});this.active=true}this.$avatarModal.one("hidden.bs.modal",function(){a.$avatarPreview.empty();a.stopCropper()})},stopCropper:function(){console.log("stop cropper");if(this.active){this.$img.cropper("destroy");this.$img.remove();this.active=false}},fireUploadEvent:function(i){console.log("fireUploadEvent");var f=this.$avatarForm.attr("action");var g=new FormData(this.$avatarForm[0]);var h=this;if(this.cfg.behaviors){var e=this.cfg.behaviors.itemSelect;if(e){var d={params:[{name:this.id+"_newTab",value:e.attr("id")},{name:this.id+"_tabindex",value:parseInt(e.index()/2)}]};e.call(this,d)}}},ajaxUpload:function(){console.log("ajax upload");console.log(this.$avatarForm);var a=this.$avatarForm.attr("action");var b=new FormData(this.$avatarForm[0]);var c=this;$.ajax(a,{type:"post",data:b,dataType:"json",processData:false,contentType:false,beforeSend:function(){c.submitStart()},success:function(d){c.submitDone(d)},error:function(d,f,e){c.submitFail(f||e)},complete:function(){c.submitEnd()}})},syncUpload:function(){console.log("syncUpload");this.$avatarSave.click()},submitStart:function(){console.log("submitStart");this.$loading.fadeIn()},submitDone:function(a){console.log("submitDone");console.log(a);if($.isPlainObject(a)&&a.state===200){if(a.result){this.url=a.result;if(this.support.datauri||this.uploaded){this.uploaded=false;this.cropDone()}else{this.uploaded=true;this.$avatarSrc.val(this.url);this.startCropper()}this.$avatarInput.val("")}else{if(a.message){this.alert(a.message)}}}else{this.alert("Failed to response")}},submitFail:function(a){console.log("submitFail");this.alert(a)},submitEnd:function(){console.log("submitFail");this.$loading.fadeOut()},cropDone:function(){this.$avatarForm.get(0).reset();this.$avatar.attr("src",this.url);this.stopCropper();this.$avatarModal.modal("hide")},alert:function(b){var a=['<div class="alert alert-danger avatar-alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert">&times;</button>',b,"</div>"].join("");this.$avatarUpload.after(a)}});